<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>量子番茄钟 | 专注与休息</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* 背景粒子效果 */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(100, 255, 218, 0.7);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.8), 0 0 20px rgba(100, 255, 218, 0.6);
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.5; }
            50% { transform: translate(20px, -30px) scale(1.5); opacity: 1; }
        }

        .quantum-ring {
            position: absolute;
            border-radius: 50%;
            border: 1px solid rgba(100, 255, 218, 0.3);
            box-shadow: 0 0 50px rgba(100, 255, 218, 0.2);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.2; }
            50% { transform: scale(1.1); opacity: 0.4; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 40px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(45deg, #64ffda, #00bcd4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo i {
            font-size: 2.2rem;
        }

        .settings-toggle {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 101;
        }

        .settings-toggle:hover {
            background: rgba(100, 255, 218, 0.2);
            transform: rotate(30deg);
        }

        .settings-toggle i {
            font-size: 1.3rem;
            color: #64ffda;
        }

        .stats {
            display: flex;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 15px;
            padding: 15px 25px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #64ffda;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #a0a0a0;
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 40px;
        }

        .timer-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .timer-display {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 40px 0;
        }

        .progress-ring {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s linear;
        }

        .timer-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .timer-mode {
            font-size: 1.8rem;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .timer-time {
            font-size: 4rem;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            position: relative;
            z-index: 10;
        }

        .timer-label {
            color: #a0a0a0;
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .breathing-bubble {
            position: absolute;
            width: 220px;
            height: 220px;
            background: rgba(100, 255, 218, 0.25);
            border-radius: 50%;
            filter: blur(15px);
            z-index: 1;
            animation: breathe 3s ease-in-out infinite;
            display: none;
        }

        @keyframes breathe {
            0%, 100% {
                transform: scale(0.85);
                opacity: 0.4;
            }
            50% {
                transform: scale(1.25);
                opacity: 0.75;
            }
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196f3, #64ffda);
            color: #0c0c0c;
            box-shadow: 0 5px 20px rgba(100, 255, 218, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(100, 255, 218, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(100, 255, 218, 0.5);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn i {
            font-size: 1.2rem;
        }

        .mode-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 30px;
            padding: 5px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }

        .mode-btn {
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #a0a0a0;
        }
        .mode-btn.active {
            background: linear-gradient(45deg, #2196f3, #64ffda);
            color: #0c0c0c;
            box-shadow: 0 5px 15px rgba(100, 255, 218, 0.3);
        }
        .mode-btn:not(.active):hover {
            color: #ffffff;
            background: rgba(100, 255, 218, 0.1);
        }

        .suggestions-section {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            border-color: rgba(100, 255, 218, 0.5);
        }

        .card-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #64ffda;
        }

        .card-title i {
            font-size: 1.5rem;
        }

        .suggestion-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background: rgba(100, 255, 218, 0.1);
            transform: translateX(5px);
        }

        .suggestion-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(100, 255, 218, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .suggestion-text {
            flex: 1;
            font-size: 0.95rem;
        }

        /* 设置面板 */
        .settings-panel {
            position: absolute;
            top: 90px;
            left: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            width: 320px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px) translateX(-100%);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        .settings-panel.show {
            transform: translateY(0) translateX(0);
            opacity: 1;
            pointer-events: all;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .setting-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-input input[type="range"] {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .setting-input input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
        }

        .setting-input input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
            border: none;
        }

        .setting-input .value-display {
            min-width: 30px;
            text-align: center;
            font-size: 0.9rem;
            color: #64ffda;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #a0a0a0;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(45deg, #2196f3, #64ffda);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
            background-color: #0c0c0c;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 15px;
            padding: 15px 25px;
            backdrop-filter: blur(10px);
            transform: translateX(calc(100% + 30px));
            transition: transform 0.4s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 1.5rem;
            color: #64ffda;
        }

        /* Mode specific styles */
        .focus-mode .progress-ring-circle { stroke: url(#gradientFocus); }
        .short-break-mode .progress-ring-circle { stroke: url(#gradientShortBreak); }
        .long-break-mode .progress-ring-circle { stroke: url(#gradientLongBreak); }

        .focus-mode .timer-mode { color: #64ffda; }
        .short-break-mode .timer-mode { color: #2196f3; }
        .long-break-mode .timer-mode { color: #9c27b0; }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            
            .suggestions-section {
                width: 100%;
                margin-top: 20px;
            }
            
            .timer-display {
                width: 280px;
                height: 280px;
            }
            
            header {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }

            .header-left {
                width: 100%;
                justify-content: space-between;
            }
            .stats {
                justify-content: space-around;
            }
        }

        @media (max-width: 480px) {
            .timer-display {
                width: 240px;
                height: 240px;
            }
            
            .timer-time {
                font-size: 3rem;
            }
            
            .stats {
                width: 100%;
                justify-content: space-around;
                padding: 10px 15px;
            }
             .stat-value { font-size: 1.5rem; }
             .stat-label { font-size: 0.8rem; }
            
            .controls {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .mode-selector {
                flex-wrap: wrap;
                justify-content: center;
            }
            .mode-btn {
                padding: 10px 15px;
                margin: 5px;
            }

            .settings-panel {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                top: 70px;
            }
            .notification {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    
    <div class="quantum-ring" style="width: 800px; height: 800px; top: -400px; right: -400px;"></div>
    <div class="quantum-ring" style="width: 600px; height: 600px; bottom: -300px; left: -300px;"></div>

    <div class="container">
        <header>
            <div class="header-left">
                <div class="settings-toggle" id="settings-toggle">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="logo">
                    <i class="fas fa-atom"></i>
                    <span>量子番茄钟</span>
                </div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="focus-count">0</div>
                    <div class="stat-label">专注次数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="break-count">0</div>
                    <div class="stat-label">短休次数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="long-break-count">0</div>
                    <div class="stat-label">长休次数</div>
                </div>
            </div>
        </header>
        
        <div class="settings-panel" id="settings-panel">
            <h3 class="card-title"><i class="fas fa-cog"></i> 设置</h3>
            <div class="setting-item">
                <div class="setting-label">
                    <i class="fas fa-volume-up"></i>
                    <span>提示音</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="sound-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <i class="fas fa-bell"></i>
                    <span>结束通知</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="notification-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <i class="fas fa-vibrate"></i>
                    <span>震动提醒</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="vibration-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <i class="fas fa-paint-brush"></i>
                    <span>呼吸气泡效果</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="bubble-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <i class="fas fa-music"></i>
                    <span>专注结束音乐延迟</span>
                </div>
                <div class="setting-input">
                    <input type="range" id="focus-music-delay" min="0" max="30" value="10">
                    <div class="value-display" id="focus-music-delay-value">10s</div>
                </div>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <i class="fas fa-spa"></i>
                    <span>休息结束前舒缓音乐</span>
                </div>
                <div class="setting-input">
                    <input type="range" id="break-music-delay" min="0" max="30" value="10">
                    <div class="value-display" id="break-music-delay-value">10s</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="timer-section">
                <div class="timer-display">
                    <svg class="progress-ring" id="progress-ring" viewBox="0 0 320 320">
                        <defs>
                            <linearGradient id="gradientFocus" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#64ffda;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#00bcd4;stop-opacity:1" />
                            </linearGradient>
                             <linearGradient id="gradientShortBreak" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#2196f3;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#64b5f6;stop-opacity:1" />
                            </linearGradient>
                             <linearGradient id="gradientLongBreak" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#9c27b0;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ba68c8;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle class="progress-ring-circle" stroke="url(#gradientFocus)" stroke-width="8" fill="transparent" r="150" cx="160" cy="160"/>
                    </svg>
                    <div class="timer-content">
                        <div class="timer-mode" id="timer-mode">专注时间</div>
                        <div class="timer-time" id="timer">25:00</div>
                        <div class="breathing-bubble" id="breathing-bubble"></div>
                        <div class="timer-label" id="timer-label">开始专注工作</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" id="start-btn">
                        <i class="fas fa-play"></i>
                        <span>开始</span>
                    </button>
                    <button class="btn btn-secondary" id="pause-btn">
                        <i class="fas fa-pause"></i>
                        <span>暂停</span>
                    </button>
                    <button class="btn btn-secondary" id="skip-btn">
                        <i class="fas fa-step-forward"></i>
                        <span>跳过</span>
                    </button>
                </div>
                
                <div class="mode-selector">
                    <div class="mode-btn active" data-mode="focus">专注 (25:00)</div>
                    <div class="mode-btn" data-mode="short-break">短休 (5:00)</div>
                    <div class="mode-btn" data-mode="long-break">长休 (15:00)</div>
                </div>
            </div>
            
            <div class="suggestions-section">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-lightbulb"></i> 休息建议</h3>
                    <div class="suggestion-list">
                        <div class="suggestion-item">
                            <div class="suggestion-icon">👀</div>
                            <div class="suggestion-text">远眺窗外，放松眼睛</div>
                        </div>
                        <div class="suggestion-item">
                            <div class="suggestion-icon">🧘‍♀️</div>
                            <div class="suggestion-text">深呼吸，放松身心</div>
                        </div>
                        <div class="suggestion-item">
                            <div class="suggestion-icon">💧</div>
                            <div class="suggestion-text">喝一杯水，补充水分</div>
                        </div>
                        <div class="suggestion-item">
                            <div class="suggestion-icon">🤸‍♂️</div>
                            <div class="suggestion-text">起身活动，伸展筋骨</div>
                        </div>
                        <div class="suggestion-item">
                            <div class="suggestion-icon">🎵</div>
                            <div class="suggestion-text">听一首轻松的音乐</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-history"></i> 专注历史</h3>
                    <div class="suggestion-list" id="history-list">
                        <div class="suggestion-item">
                            <div class="suggestion-icon">⏱️</div>
                            <div class="suggestion-text">今天：<span id="today-focus-count">0</span>次专注, 共 <span id="today-focus-minutes">0</span>分钟</div>
                        </div>
                         <div class="suggestion-item">
                            <div class="suggestion-icon">📅</div>
                            <div class="suggestion-text">本周：<span id="week-focus-count">0</span>次专注, 共 <span id="week-focus-minutes">0</span>分钟</div>
                        </div>
                         <div class="suggestion-item">
                            <div class="suggestion-icon">🏆</div>
                            <div class="suggestion-text">最长专注：<span id="max-focus-duration">0</span>分钟</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="notification-text" id="notification-text">专注时间结束！该休息一下了。</div>
    </div>
    
    <audio id="alarm-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
    <audio id="focus-end-music" loop preload="auto">
        <source src="https://assets.mixkit.co/music/preview/mixkit-grocery-lite-1263.mp3" type="audio/mpeg">
    </audio>
    <audio id="break-end-music" loop preload="auto">
        <source src="https://assets.mixkit.co/music/preview/mixkit-relaxing-piano-music-2863.mp3" type="audio/mpeg">
    </audio>

    <script>
        'use strict';

        // State Management
        const state = {
            mode: 'focus', // focus, short-break, long-break
            running: false,
            timeLeft: 25 * 60, // seconds
            focusTime: 25 * 60,
            shortBreakTime: 5 * 60,
            longBreakTime: 15 * 60,
            interval: null,
            focusCount: 0,
            breakCount: 0,
            longBreakCount: 0,
            bubbleEnabled: true, // Initialize with default value
            // Music delay settings (in seconds)
            focusMusicDelay: 10,
            breakMusicDelay: 10,
            // Music timeout IDs for clearing
            focusMusicTimeout: null,
            breakMusicTimeout: null,
            // For history (can be expanded with localStorage)
            todayFocusSessions: 0,
            todayFocusMinutes: 0,
            weekFocusSessions: 0,
            weekFocusMinutes: 0,
            maxFocusDuration: 0,
        };

        // DOM Elements
        const elements = {
            timer: document.getElementById('timer'),
            timerMode: document.getElementById('timer-mode'),
            timerLabel: document.getElementById('timer-label'),
            startBtn: document.getElementById('start-btn'),
            pauseBtn: document.getElementById('pause-btn'),
            skipBtn: document.getElementById('skip-btn'),
            focusCountDisplay: document.getElementById('focus-count'),
            breakCountDisplay: document.getElementById('break-count'),
            longBreakCountDisplay: document.getElementById('long-break-count'),
            progressCircle: document.querySelector('.progress-ring-circle'),
            progressRingSvg: document.getElementById('progress-ring'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notification-text'),
            alarmSound: document.getElementById('alarm-sound'),
            focusEndMusic: document.getElementById('focus-end-music'),
            breakEndMusic: document.getElementById('break-end-music'),
            soundToggle: document.getElementById('sound-toggle'),
            notificationToggle: document.getElementById('notification-toggle'),
            vibrationToggle: document.getElementById('vibration-toggle'),
            bubbleToggle: document.getElementById('bubble-toggle'),
            breathingBubble: document.getElementById('breathing-bubble'),
            settingsToggle: document.getElementById('settings-toggle'),
            settingsPanel: document.getElementById('settings-panel'),
            // Music delay controls
            focusMusicDelaySlider: document.getElementById('focus-music-delay'),
            focusMusicDelayValue: document.getElementById('focus-music-delay-value'),
            breakMusicDelaySlider: document.getElementById('break-music-delay'),
            breakMusicDelayValue: document.getElementById('break-music-delay-value'),
            // History display elements
            todayFocusCountDisplay: document.getElementById('today-focus-count'),
            todayFocusMinutesDisplay: document.getElementById('today-focus-minutes'),
            weekFocusCountDisplay: document.getElementById('week-focus-count'),
            weekFocusMinutesDisplay: document.getElementById('week-focus-minutes'),
            maxFocusDurationDisplay: document.getElementById('max-focus-duration'),
        };

        // Create Background Particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            const particleCount = 80;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 5 + 5) + 's';
                const size = (Math.random() * 2 + 1) + 'px';
                particle.style.width = size;
                particle.style.height = size;
                particlesContainer.appendChild(particle);
            }
        }

        // Update Progress Ring
        function updateProgressRing() {
            const radius = parseFloat(elements.progressCircle.getAttribute('r'));
            const circumference = 2 * Math.PI * radius;
            let timeTotal;
            
            switch(state.mode) {
                case 'focus': timeTotal = state.focusTime; break;
                case 'short-break': timeTotal = state.shortBreakTime; break;
                case 'long-break': timeTotal = state.longBreakTime; break;
                default: timeTotal = state.focusTime;
            }
            
            const offset = circumference - (state.timeLeft / timeTotal) * circumference;
            elements.progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            elements.progressCircle.style.strokeDashoffset = Math.max(0, offset);
        }

        // Format Time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update Timer Display
        function updateTimerDisplay() {
            elements.timer.textContent = formatTime(state.timeLeft);
            document.title = `${formatTime(state.timeLeft)} - ${elements.timerMode.textContent} | 量子番茄钟`;
            updateProgressRing();
        }

        // Clear Music Timeouts
        function clearMusicTimeouts() {
            if (state.focusMusicTimeout) {
                clearTimeout(state.focusMusicTimeout);
                state.focusMusicTimeout = null;
            }
            if (state.breakMusicTimeout) {
                clearTimeout(state.breakMusicTimeout);
                state.breakMusicTimeout = null;
            }
        }

        // Stop All Music
        function stopAllMusic() {
            elements.focusEndMusic.pause();
            elements.focusEndMusic.currentTime = 0;
            elements.breakEndMusic.pause();
            elements.breakEndMusic.currentTime = 0;
        }

        // Schedule Focus End Music
        function scheduleFocusEndMusic() {
            if (state.mode !== 'focus' || !elements.soundToggle.checked) return;
            
            const delayMs = state.focusMusicDelay * 1000;
            state.focusMusicTimeout = setTimeout(() => {
                elements.focusEndMusic.play().catch(e => console.warn("Focus end music play failed:", e));
                
                // Stop music after 20 seconds
                setTimeout(() => {
                    elements.focusEndMusic.pause();
                    elements.focusEndMusic.currentTime = 0;
                }, 20000);
            }, delayMs);
        }

        // Schedule Break End Music (before break ends)
        function scheduleBreakEndMusic() {
            if (state.mode === 'focus' || !elements.soundToggle.checked) return;
            
            const timeBeforeEnd = state.breakMusicDelay;
            const triggerTime = state.timeLeft - timeBeforeEnd;
            
            if (triggerTime <= 0) {
                // If we're already within the trigger time, play immediately
                elements.breakEndMusic.play().catch(e => console.warn("Break end music play failed:", e));
                return;
            }
            
            const delayMs = triggerTime * 1000;
            state.breakMusicTimeout = setTimeout(() => {
                elements.breakEndMusic.play().catch(e => console.warn("Break end music play failed:", e));
            }, delayMs);
        }

        // Set Mode
        function setMode(mode) {
            // Clear any existing music timeouts
            clearMusicTimeouts();
            stopAllMusic();
            
            state.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // Remove previous mode classes and add current one
            document.body.classList.remove('focus-mode', 'short-break-mode', 'long-break-mode');
            document.body.classList.add(`${mode}-mode`);
            
            let currentGradientUrl;
            switch(mode) {
                case 'focus':
                    state.timeLeft = state.focusTime;
                    elements.timerMode.textContent = '专注时间';
                    elements.timerLabel.textContent = '开始专注工作';
                    currentGradientUrl = 'url(#gradientFocus)';
                    break;
                case 'short-break':
                    state.timeLeft = state.shortBreakTime;
                    elements.timerMode.textContent = '短时休息';
                    elements.timerLabel.textContent = '放松一下，休息5分钟';
                    currentGradientUrl = 'url(#gradientShortBreak)';
                    break;
                case 'long-break':
                    state.timeLeft = state.longBreakTime;
                    elements.timerMode.textContent = '长时休息';
                    elements.timerLabel.textContent = '好好放松，休息15分钟';
                    currentGradientUrl = 'url(#gradientLongBreak)';
                    break;
                default:
                    currentGradientUrl = 'url(#gradientFocus)';
            }
            elements.progressCircle.setAttribute('stroke', currentGradientUrl);
            updateTimerDisplay();
        }

        // Start Timer
        function startTimer() {
            if (state.timeLeft <= 0) resetTimer();
            if (state.running) return;
            
            state.running = true;
            elements.startBtn.innerHTML = '<i class="fas fa-redo"></i><span>重置</span>';
            elements.pauseBtn.disabled = false;
            
            // Schedule music based on current mode
            if (state.mode === 'focus') {
                scheduleFocusEndMusic();
            } else {
                scheduleBreakEndMusic();
            }
            
            state.interval = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft < 0) {
                    clearInterval(state.interval);
                    state.timeLeft = 0;
                    updateTimerDisplay();
                    timerComplete();
                }
            }, 1000);
        }

        // Pause Timer
        function pauseTimer() {
            if (!state.running) return;
            
            clearInterval(state.interval);
            clearMusicTimeouts();
            stopAllMusic();
            state.running = false;
            elements.startBtn.innerHTML = '<i class="fas fa-play"></i><span>继续</span>';
            elements.pauseBtn.disabled = true;
        }

        // Reset Timer
        function resetTimer() {
            clearInterval(state.interval);
            clearMusicTimeouts();
            stopAllMusic();
            state.running = false;
            
            setMode(state.mode);
            
            elements.startBtn.innerHTML = '<i class="fas fa-play"></i><span>开始</span>';
            elements.pauseBtn.disabled = false;
            updateTimerDisplay();
        }
        
        function updateHistoryStats() {
            elements.todayFocusCountDisplay.textContent = state.todayFocusSessions;
            elements.todayFocusMinutesDisplay.textContent = state.todayFocusMinutes;
        }

        // Timer Complete
        function timerComplete() {
            state.running = false;
            clearMusicTimeouts();
            
            if (elements.soundToggle.checked) {
                elements.alarmSound.play().catch(e => console.warn("Audio play failed:", e));
            }
            
            if (elements.vibrationToggle.checked && navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
            
            if (elements.notificationToggle.checked) {
                let message = '';
                if (state.mode === 'focus') {
                    message = '专注时间结束！该休息一下了。';
                } else {
                    message = '休息时间结束！该继续专注工作了。';
                }
                showNotification(message);
            }
            
            if (state.mode === 'focus') {
                state.focusCount++;
                elements.focusCountDisplay.textContent = state.focusCount;
                
                state.todayFocusSessions++;
                state.todayFocusMinutes += Math.floor(state.focusTime / 60);
                updateHistoryStats();

                if (state.focusCount > 0 && state.focusCount % 4 === 0) {
                    setMode('long-break');
                } else {
                    setMode('short-break');
                }
            } else if (state.mode === 'short-break') {
                state.breakCount++;
                elements.breakCountDisplay.textContent = state.breakCount;
                setMode('focus');
            } else if (state.mode === 'long-break') {
                state.longBreakCount++;
                elements.longBreakCountDisplay.textContent = state.longBreakCount;
                setMode('focus');
            }
            
            elements.startBtn.innerHTML = '<i class="fas fa-play"></i><span>开始</span>';
        }

        // Skip Current Timer
        function skipTimer() {
            clearInterval(state.interval);
            clearMusicTimeouts();
            stopAllMusic();
            state.timeLeft = 0;
            updateTimerDisplay();
            timerComplete();
        }

        // Show Notification
        function showNotification(text) {
            elements.notificationText.textContent = text;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 5000);
        }

        // Toggle Breathing Bubble Effect
        function toggleBubbleEffect() {
            elements.breathingBubble.style.display = state.bubbleEnabled ? 'block' : 'none';
        }

        // Update Music Delay Display
        function updateMusicDelayDisplays() {
            elements.focusMusicDelayValue.textContent = state.focusMusicDelay + 's';
            elements.breakMusicDelayValue.textContent = state.breakMusicDelay + 's';
        }

        // Initialize
        function init() {
            createParticles();
            setMode('focus');
            
            // Initialize bubble toggle state
            state.bubbleEnabled = elements.bubbleToggle.checked;
            
            // Initialize music delay sliders
            elements.focusMusicDelaySlider.value = state.focusMusicDelay;
            elements.breakMusicDelaySlider.value = state.breakMusicDelay;
            updateMusicDelayDisplays();
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setMode(btn.dataset.mode);
                    resetTimer();
                });
            });
            
            elements.startBtn.addEventListener('click', () => {
                if (elements.startBtn.textContent.includes('重置') || elements.startBtn.textContent.includes('Reset')) {
                     resetTimer();
                } else if (state.running) {
                    pauseTimer(); 
                }
                else {
                    startTimer();
                }
            });
            
            elements.pauseBtn.addEventListener('click', pauseTimer);
            elements.skipBtn.addEventListener('click', skipTimer);
            
            elements.bubbleToggle.addEventListener('change', () => {
                state.bubbleEnabled = elements.bubbleToggle.checked;
                toggleBubbleEffect();
            });
            
            // Music delay slider event listeners
            elements.focusMusicDelaySlider.addEventListener('input', (e) => {
                state.focusMusicDelay = parseInt(e.target.value);
                updateMusicDelayDisplays();
            });
            
            elements.breakMusicDelaySlider.addEventListener('input', (e) => {
                state.breakMusicDelay = parseInt(e.target.value);
                updateMusicDelayDisplays();
            });
            
            elements.settingsToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                elements.settingsPanel.classList.toggle('show');
            });
            
            document.addEventListener('click', (e) => {
                if (elements.settingsPanel.classList.contains('show') &&
                    !elements.settingsPanel.contains(e.target) &&
                    !elements.settingsToggle.contains(e.target)) {
                    elements.settingsPanel.classList.remove('show');
                }
            });
            
            toggleBubbleEffect();
            updateHistoryStats();
            elements.pauseBtn.disabled = true;
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
